{"version":3,"file":"vite-config.js","sourceRoot":"","sources":["../vite-config.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path';\nimport fs from 'fs';\nimport { Plugin } from 'vite';\nimport { allowedEnvPrefix as envPrefix } from './envs';\nimport { TypescriptConfig } from '@storybook/core-common';\nimport { mockCoreJs } from './mock-core-js';\nimport { codeGeneratorPlugin } from './code-generator-plugin';\nimport { injectExportOrderPlugin } from './inject-export-order-plugin';\nimport { mdxPlugin } from './mdx-plugin';\nimport { noFouc } from './plugins/no-fouc';\nimport { sourceLoaderPlugin } from './source-loader-plugin';\n\nimport type { UserConfig } from 'vite';\nimport type { ExtendedOptions } from './types';\n\nexport type PluginConfigType = 'build' | 'development';\n\nexport function readPackageJson(): Record<string, any> | false {\n  const packageJsonPath = path.resolve('package.json');\n  if (!fs.existsSync(packageJsonPath)) {\n    return false;\n  }\n\n  const jsonContent = fs.readFileSync(packageJsonPath, 'utf8');\n  return JSON.parse(jsonContent);\n}\n\n// Vite config that is common to development and production mode\nexport async function commonConfig(\n  options: ExtendedOptions,\n  _type: PluginConfigType\n): Promise<UserConfig & { configFile: false; root: string }> {\n  const { framework } = options;\n\n  return {\n    configFile: false,\n    root: path.resolve(options.configDir, '..'),\n    cacheDir: 'node_modules/.vite-storybook',\n    envPrefix,\n    define: {},\n    resolve:\n      framework === 'vue3'\n        ? {\n            alias: {\n              vue: 'vue/dist/vue.esm-bundler.js',\n            },\n          }\n        : {},\n    plugins: await pluginConfig(options, _type),\n  };\n}\n\nexport async function pluginConfig(options: ExtendedOptions, _type: PluginConfigType) {\n  const { framework, presets } = options;\n  const svelteOptions: Record<string, any> = await presets.apply('svelteOptions', {}, options);\n\n  const plugins = [\n    codeGeneratorPlugin(options),\n    mockCoreJs(),\n    sourceLoaderPlugin(options),\n    mdxPlugin(),\n    noFouc(),\n    injectExportOrderPlugin,\n  ] as Plugin[];\n  if (framework === 'vue' || framework === 'vue3') {\n    try {\n      const vuePlugin = require('@vitejs/plugin-vue');\n      plugins.push(vuePlugin());\n      const { vueDocgen } = await import('./plugins/vue-docgen');\n      plugins.push(vueDocgen());\n    } catch (err) {\n      if ((err as NodeJS.ErrnoException).code === 'MODULE_NOT_FOUND') {\n        throw new Error(\n          '@storybook/builder-vite requires @vitejs/plugin-vue to be installed ' +\n            'when using @storybook/vue or @storybook/vue3.' +\n            '  Please install it and start storybook again.'\n        );\n      }\n      throw err;\n    }\n  }\n  if (framework === 'svelte') {\n    try {\n      const sveltePlugin = require('@sveltejs/vite-plugin-svelte').svelte;\n\n      // We need to create two separate svelte plugins, one for stories, and one for other svelte files\n      // because stories.svelte files cannot be hot-module-reloaded.\n      // Suggested in: https://github.com/sveltejs/vite-plugin-svelte/issues/321#issuecomment-1113205509\n\n      // First, create an array containing user exclude patterns, to combine with ours.\n      const userExclude = Array.isArray(svelteOptions?.exclude)\n        ? svelteOptions?.exclude\n        : svelteOptions?.exclude\n        ? [svelteOptions?.exclude]\n        : [];\n\n      // These are the svelte stories we need to exclude from HMR\n      const storyPatterns = ['**/*.story.svelte', '**/*.stories.svelte'];\n      // Non-story svelte files\n      // Starting in 1.0.0-next.42, svelte.config.js is included by default.\n      // We disable that, but allow it to be overridden in svelteOptions\n      plugins.push(sveltePlugin({ configFile: false, ...svelteOptions, exclude: [...userExclude, ...storyPatterns] }));\n      // Svelte stories without HMR\n      const storySveltePlugin = sveltePlugin({\n        configFile: false,\n        ...svelteOptions,\n        exclude: userExclude,\n        include: storyPatterns,\n        hot: false,\n      });\n      plugins.push({\n        // Starting in 1.0.0-next.43, the plugin function returns an array of plugins.  We only want the first one here.\n        ...(Array.isArray(storySveltePlugin) ? storySveltePlugin[0] : storySveltePlugin),\n        name: 'vite-plugin-svelte-stories',\n      });\n    } catch (err) {\n      if ((err as NodeJS.ErrnoException).code === 'MODULE_NOT_FOUND') {\n        throw new Error(\n          '@storybook/builder-vite requires @sveltejs/vite-plugin-svelte to be installed' +\n            ' when using @storybook/svelte.' +\n            '  Please install it and start storybook again.'\n        );\n      }\n      throw err;\n    }\n\n    try {\n      const csfPlugin = require('./svelte/csf-plugin').default;\n      plugins.push(csfPlugin(svelteOptions));\n    } catch (err) {\n      // Not all projects use `.stories.svelte` for stories, and by default 6.5+ does not auto-install @storybook/addon-svelte-csf.\n      // If it's any other kind of error, re-throw.\n      if ((err as NodeJS.ErrnoException).code !== 'MODULE_NOT_FOUND') {\n        throw err;\n      }\n    }\n\n    const { svelteDocgen } = await import('./plugins/svelte-docgen');\n    plugins.push(svelteDocgen(svelteOptions));\n  }\n\n  if (framework === 'react') {\n    plugins.push(\n      require('@vitejs/plugin-react')({\n        // Do not treat story files as HMR boundaries, storybook itself needs to handle them.\n        exclude: [/\\.stories\\.([tj])sx?$/, /node_modules/],\n      })\n    );\n\n    const { reactDocgen, reactDocgenTypescriptOptions } = await presets.apply('typescript', {} as TypescriptConfig);\n\n    let typescriptPresent;\n\n    try {\n      const pkgJson = readPackageJson();\n      typescriptPresent = pkgJson && (pkgJson?.devDependencies?.typescript || pkgJson?.dependencies?.typescript);\n    } catch (e) {\n      typescriptPresent = false;\n    }\n\n    if (reactDocgen === 'react-docgen-typescript' && typescriptPresent) {\n      plugins.push(require('@joshwooding/vite-plugin-react-docgen-typescript').default(reactDocgenTypescriptOptions));\n    } else if (reactDocgen) {\n      const { reactDocgen } = await import('./plugins/react-docgen');\n      // Needs to run before the react plugin, so add to the front\n      plugins.unshift(reactDocgen());\n    }\n  }\n\n  if (framework === 'glimmerx') {\n    const plugin = require('vite-plugin-glimmerx/index.cjs');\n    plugins.push(plugin.default());\n  }\n\n  return plugins;\n}\n"]}