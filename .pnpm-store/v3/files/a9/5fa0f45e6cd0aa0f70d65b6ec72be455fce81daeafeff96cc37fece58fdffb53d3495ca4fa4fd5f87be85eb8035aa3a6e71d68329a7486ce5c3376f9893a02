{"version":3,"file":"optimizeDeps.js","sourceRoot":"","sources":["../optimizeDeps.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path';\nimport { normalizePath, resolveConfig, UserConfig } from 'vite';\nimport { listStories } from './list-stories';\n\nimport type { ExtendedOptions } from './types';\n\nconst INCLUDE_CANDIDATES = [\n  '@base2/pretty-print-object',\n  '@emotion/core',\n  '@emotion/is-prop-valid',\n  '@emotion/styled',\n  '@mdx-js/react',\n  '@storybook/addon-docs > acorn-jsx',\n  '@storybook/addon-docs',\n  '@storybook/addons',\n  '@storybook/channel-postmessage',\n  '@storybook/channel-websocket',\n  '@storybook/client-api',\n  '@storybook/client-logger',\n  '@storybook/core/client',\n  '@storybook/csf',\n  '@storybook/preview-web',\n  '@storybook/react > acorn-jsx',\n  '@storybook/react',\n  '@storybook/svelte',\n  '@storybook/vue3',\n  'acorn-jsx',\n  'acorn-walk',\n  'acorn',\n  'airbnb-js-shims',\n  'ansi-to-html',\n  'axe-core',\n  'color-convert',\n  'deep-object-diff',\n  'doctrine',\n  'emotion-theming',\n  'escodegen',\n  'estraverse',\n  'fast-deep-equal',\n  'global',\n  'html-tags',\n  'isobject',\n  'jest-mock',\n  'loader-utils',\n  'lodash/cloneDeep',\n  'lodash/isFunction',\n  'lodash/isPlainObject',\n  'lodash/isString',\n  'lodash/mapKeys',\n  'lodash/mapValues',\n  'lodash/pick',\n  'lodash/pickBy',\n  'lodash/startCase',\n  'lodash/throttle',\n  'lodash/uniq',\n  'markdown-to-jsx',\n  'memoizerific',\n  'overlayscrollbars',\n  'polished',\n  'prettier/parser-babel',\n  'prettier/parser-flow',\n  'prettier/parser-typescript',\n  'prop-types',\n  'qs',\n  'react-dom',\n  'react-dom/client',\n  'react-fast-compare',\n  'react-is',\n  'react-textarea-autosize',\n  'react',\n  'refractor/core',\n  'refractor/lang/bash.js',\n  'refractor/lang/css.js',\n  'refractor/lang/graphql.js',\n  'refractor/lang/js-extras.js',\n  'refractor/lang/json.js',\n  'refractor/lang/jsx.js',\n  'refractor/lang/markdown.js',\n  'refractor/lang/markup.js',\n  'refractor/lang/tsx.js',\n  'refractor/lang/typescript.js',\n  'refractor/lang/yaml.js',\n  'regenerator-runtime/runtime.js',\n  'slash',\n  'stable',\n  'store2',\n  'synchronous-promise',\n  'telejson',\n  'ts-dedent',\n  'unfetch',\n  'util-deprecate',\n  'uuid-browser/v4',\n  'vue',\n  'warning',\n];\n\n/**\n * Helper function which allows us to `filter` with an async predicate.  Uses Promise.all for performance.\n */\nconst asyncFilter = async (arr: string[], predicate: (val: string) => Promise<boolean>) =>\n  Promise.all(arr.map(predicate)).then((results) => arr.filter((_v, index) => results[index]));\n\nexport async function getOptimizeDeps(\n  config: UserConfig & { configFile: false; root: string },\n  options: ExtendedOptions\n) {\n  const { root } = config;\n  const absoluteStories = await listStories(options);\n  const stories = absoluteStories.map((storyPath) => normalizePath(path.relative(root, storyPath)));\n  const resolvedConfig = await resolveConfig(config, 'serve', 'development');\n\n  const exclude = [];\n  // This is necessary to support react < 18 with new versions of @storybook/react that support react 18.\n  // TODO: narrow this down to just framework === 'react'.  But causes a vue dev start problem in this monorepo.\n  try {\n    require.resolve('react-dom/client', { paths: [config.root] });\n  } catch (e) {\n    if (isNodeError(e) && e.code === 'MODULE_NOT_FOUND') {\n      exclude.push('react-dom/client');\n    }\n  }\n\n  // This function converts ids which might include ` > ` to a real path, if it exists on disk.\n  // See https://github.com/vitejs/vite/blob/67d164392e8e9081dc3f0338c4b4b8eea6c5f7da/packages/vite/src/node/optimizer/index.ts#L182-L199\n  const resolve = resolvedConfig.createResolver({ asSrc: false });\n  const include = await asyncFilter(INCLUDE_CANDIDATES, async (id) => Boolean(await resolve(id)));\n\n  return {\n    // We don't need to resolve the glob since vite supports globs for entries.\n    entries: stories,\n    // We need Vite to precompile these dependencies, because they contain non-ESM code that would break\n    // if we served it directly to the browser.\n    include,\n    // In some cases we need to prevent deps from being pre-bundled\n    exclude,\n  };\n}\n\n// Refines an error received from 'catch' to be a NodeJS exception\nconst isNodeError = (error: unknown): error is NodeJS.ErrnoException => error instanceof Error;\n"]}